<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>" />
    <title>cede: State Kernel Demo</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
      }
      html {
        color-scheme: light dark;
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
        -moz-tab-size: 4;
        tab-size: 4;
      }
      body {
        padding: 3vh 5vw;
        margin: 0;
        line-height: 1.2;
        -webkit-font-smoothing: antialiased;
        font-family:
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          Helvetica,
          Arial,
          sans-serif,
          "Apple Color Emoji",
          "Segoe UI Emoji",
          "Segoe UI Symbol";
      }
    </style>
  </head>
  <body>
    <style>

    ul#testDetail {
      list-style: none;
      li {list-style: none;}
      ul {list-style: none;}
    }
      .example {
        margin-bottom: 3rem;
      }

      .example {
        .login {
        }
        .gradient {
        }
      }
    </style>


    <style>

    :root {
      --test-text-color-primary: DarkOrange;
      --test-text-color-pass: DarkSlateGray;
      --test-text-color-fail: OrangeRed;
      --test-text-color-error: FireBrick;
    }

    .test-results {

      h1,h2,h3,h4,h5,h6 {
        color: var(--test-text-color-primary);
        margin-bottom: 1rem;
      }

      .test {

        padding: 0.5rem;
        margin-bottom: 1rem;

        &.test-pass {
          color: var(--test-text-color-pass);
        }

        &.test-fail {
          color: var(--test-text-color-fail);
        }

        &.test-error {
          color: var(--test-text-color-error);
          padding:1rem;

        }

        &.test-summary {
          color: var(--test-text-color-pass);
        }

      }

    }

    </style>

    <div style="display: flex">
      <div id="gradientApp" style="flex: 50%"></div>
      <div id="loginApp" style="flex: 50%"></div>
    </div>

    <div id="results" class="test-results"></div>




    <script type="module">
      import { ById, CurrentWorkingDirectory, DisposableSignalListener, DisposableSingleDirectionBinder, DisposableBidirectionalBinder, DisposableEventBinder, DisposableManager, TemplateManager } from "./Disposables.js";
      import { ApplicationLifecycle, TemplateLifecycle, GradientLifecycle, ColorStopControlLifecycle } from "./Lifecycles.js";

      import { test, describe, it, waitForCompletion } from "./modules/cletus/cletus.js";
      import { sleep } from "./utilities.js";

      import { Builder, Obj, Arr, Signal } from "./modules/supernatural/index.js";

      import { Tree } from "./Tree.js";

      localStorage.clear();

      // Start The Lifecycle Tree (The Root)

      const app = new ApplicationLifecycle({id:"app", container:document.body});
      /// NOTE: the reactive data tree is located under app.tree, ex: app.tree.dump();
      app.initialize();

      // Lifecycle

      describe("Lifecycle And Tree Operations", () => {

        it("should write base template for gradient app", {}, () => {
          const gradientApp = new TemplateLifecycle({id:"gradientTemplate1", template:"gradientTemplate", container:"gradientApp"});
          app.addChild(gradientApp);

          it("should write reactive UI and initialize", {}, () => {
            const gradientPreviewBox = new GradientLifecycle({id:"gradientPreviewBox"});
            gradientApp.addChild(gradientPreviewBox);

            const gradientControlBox = new ColorStopControlLifecycle({id:"gradientControlBox"});
            gradientApp.addChild(gradientControlBox);

            gradientApp.initializeAll();
          });

          it("should write reactive gradient data structures", {}, async () => {
            // const gradients = app.tree.read("/my-app/user/gradient.arr");
            // const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;

            app.tree.write("/my-app/user/gradient.arr/0", { color: "#ff0000", percent: 0 });
            app.tree.write("/my-app/user/gradient.arr/1", { color: "#00ff00", percent: 33 });
            app.tree.write("/my-app/user/gradient.arr/2", { color: "#ff00ff", percent: 66 });

            await sleep(1_000);
            app.tree.write("/my-app/user/gradient.arr/3", { color: "#0000ff", percent: 100 });

            await sleep(1_000);
            app.tree.swap("/my-app/user/gradient.arr", 0, 3);

            await sleep(1_000);
            app.tree.write("/my-app/user/gradient.arr/0/", { percent: 0 });
            app.tree.write("/my-app/user/gradient.arr/3/", { percent: 100 });
          });

          it("should remove gradient application", {}, async () => {
            await sleep(1_000);
            gradientApp.terminateAll();
          });
        });



        it("should write base template for login app", {}, () => {
          const loginApp = new TemplateLifecycle({id:"loginTemplate1", template:"loginTemplate", container:"loginApp"});
          app.addChild(loginApp);
          loginApp.initializeAll();




          it("it should create profile.obj", {}, async () => {
            const expected = { password: "hunter2" };
            app.tree.write("/my-app/user/profile.obj", { username: "zerocool", password: "hunter2", logins: 3 });

            const profile = app.tree.read("/my-app/user/profile.obj");
            const username = app.tree.read("/my-app/user/profile.obj/username"); // <-- heads up these property values are signals!
            const logins = app.tree.read("/my-app/user/profile.obj/logins"); // <-- heads up these property values are signals!

            console.assert(profile instanceof Obj, "Profile's (which is .ext object) .signal must be an Obj!");

            console.assert(username instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");
            console.assert(logins instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");


          });


          it("it should remove login application ", {}, async () => {
            await sleep(1_000);
            loginApp.terminateAll();
          });

        });




        if (0) {

          it("should write profile.obj", {}, () => {
            const expected = { password: "hunter2" };
            tree.write("/my-app/user/profile.obj", { username: "zerocool", password: "hunter2" });
            const profile = tree.read("/my-app/user/profile.obj");
            console.assert(profile instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");
            const username = tree.read("/my-app/user/profile.obj/username");
            console.assert(username instanceof Signal, "profile.obj/username must be a signal");

            // return;
            // // const profile = tree.read("/my-app/user/profile.obj");
            // console.assert(profile.ext == "obj", "Does not have .obj extension");
            // console.assert(profile.signal instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");
            // console.assert(profile.signal.value instanceof Signal, "The value of the .signal must also be a signal");
            // console.assert(typeof username.value === "string", "profile.obj/username.value must be a simple primitive string.");
            // console.assert(username !== undefined, "Unable to retrieve data from tree, possibly due to new root logic where signal is an actual signal object...");
            disposableManager.addDisposable(username.subscribe((v) => (usernameRevisions.textContent = `(rev:${username.rev})`)));

            const disposableUsername = new DisposableBidirectionalBinder(username, usernameInput);
            const password = tree.read("/my-app/user/profile.obj/password");
            disposableManager.addDisposable(password.subscribe((v) => (passwordRevisions.textContent = `(rev:${password.rev})`)));
            const disposablePassword = new DisposableBidirectionalBinder(password, passwordInput);
            console.assert(password.value == "hunter2", `Incorrect password value, received:`, password.value);
            const dumpButtonClick = new DisposableEventBinder(dumpButton, "click", () => console.log(JSON.stringify(tree, null, 2)));
            disposableManager.addDisposable(dumpButtonClick);
            disposableManager.addDisposable(
              () => disposableUsername,
              () => (usernameInput.value = ""),
              () => usernameInput.setAttribute("disabled", "disabled"),
            );
            disposableManager.addDisposable(
              () => disposablePassword,
              () => (passwordInput.value = ""),
              () => passwordInput.setAttribute("disabled", "disabled"),
            );
            disposableManager.addDisposable(() => loginButton.setAttribute("disabled", "disabled"));
            disposableManager.addDisposable(() => loginForm.classList.add("disabled"));
          });


      } ;

      // 0 &&
      //   describe("Tree operations v1", () => {
      //     it("should write profile.obj", { todo: true }, () => {
      //       tree.write("/my-app/user/gradient.arr/0", { color: "red" });
      //       // tree.write("/my-app/user/gradient.arr/0", { color: "red" });

      //       const expected = { password: "hunter2" };
      //       tree.write("/my-app/user/profile.obj", { username: "zerocool", password: "hunter2" });

      //       const profile = tree.read("/my-app/user/profile.obj");
      //       console.assert(profile.ext == "obj", "Does not have .obj extension");
      //       console.assert(profile.signal instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");
      //       console.assert(profile.signal.value instanceof Signal, "The value of the .signal must also be a signal");

      //       const username = tree.read("/my-app/user/profile.obj/username");
      //       console.assert(username instanceof Signal, "profile.obj/username must be a signal");
      //       console.assert(typeof username.value === "string", "profile.obj/username.value must be a simple primitive string.");

      //       console.assert(username !== undefined, "Unable to retrieve data from tree, possibly due to new root logic where signal is an actual signal object...");
      //       console.log(username);

      //       disposableManager.addDisposable(username.subscribe((v) => (usernameRevisions.textContent = `(rev:${username.rev})`)));

      //       const disposableUsername = new DisposableBidirectionalBinder(username, usernameInput);

      //       const password = tree.read("/my-app/user/profile.obj/password");
      //       disposableManager.addDisposable(password.subscribe((v) => (passwordRevisions.textContent = `(rev:${password.rev})`)));
      //       const disposablePassword = new DisposableBidirectionalBinder(password, passwordInput);
      //       console.assert(password.value == "hunter2", `Incorrect password value, received:`, password.value);

      //       ///

      //       // console.log(JSON.stringify(profile.signal, null, 2));
      //       const dumpButtonClick = new DisposableEventBinder(dumpButton, "click", () => console.log(JSON.stringify(tree, null, 2)));
      //       disposableManager.addDisposable(dumpButtonClick);

      //       const stateLoader = async () => {
      //         const snapshot = await download("memory-beta.json");
      //         console.dir(snapshot);
      //         tree.load(snapshot);
      //       };
      //       const loadButtonClick = new DisposableEventBinder(loadButton, "click", stateLoader);
      //       disposableManager.addDisposable(loadButtonClick);

      //       ///

      //       disposableManager.addDisposable(
      //         () => disposableUsername,
      //         () => (usernameInput.value = ""),
      //         () => usernameInput.setAttribute("disabled", "disabled"),
      //       );
      //       disposableManager.addDisposable(
      //         () => disposablePassword,
      //         () => (passwordInput.value = ""),
      //         () => passwordInput.setAttribute("disabled", "disabled"),
      //       );
      //       disposableManager.addDisposable(() => loginButton.setAttribute("disabled", "disabled"));
      //       disposableManager.addDisposable(() => loginForm.classList.add("disabled"));
      //     });

      // it("should write profile.obj/password", () => {
      //   const expected = "hunter2";
      //   const password = tree.mk("/my-app/user/profile.obj/password", expected);
      //   const actual = password.value;
      //   console.assert(actual == expected);
      // });

      // it("should write gradient.arr/0/color", () => {
      //   const expected = "#ff0000";
      //   const gradient = tree.mk("/my-app/workspace/gradient.arr/0/color", expected);
      //   const actual = gradient.value;
      //   console.assert(actual == expected);
      // });

      // it("should write gradient.arr/0/percent", () => {
      //   const expected = 0;
      //   const percent = tree.mk("/my-app/workspace/gradient.arr/0/percent", expected);
      //   const actual = percent.value;
      //   console.assert(actual == expected);
      // });

      // it("should return a serializable JSON", { todo: false }, () => {
      //   // console.log( tree.save() );
      //   // const result = tree.load();
      //   // console.log("FLATTENED");
      //   // const flat = tree.flatten();
      //   // console.table(flat);
      //   // console.log(JSON.stringify(flat, 0, 2));
      //   // flat.forEach(o=>tree.mk(o))
      // });

      // it("save, clear, and load", { todo: false }, () => {
      //   // const snapshot = tree.save();
      //   // console.log("snapshot", snapshot);
      //   // tree.load(snapshot);
      // });

      // it("save, clear, and load", { todo: true }, () => {
      //   // const snapshot = tree.save();
      //   // tree.persist();
      //   // tree.clear();
      //   // disposableManager.dispose();
      //   // console.log("snapshot", snapshot);
      //   // tree.load(snapshot);
      // });
      });

      // Wait for tests to complete and display results
      const results = await waitForCompletion();
      const testResultContainer = document.getElementById("results")
      const detailsElement = document.createElement('ol');
      testResultContainer.appendChild(detailsElement);
      if(0){
        const summaryElement = document.createElement('pre');
        summaryElement.textContent = `Passed: ${results.summary.passed}\n` + `Failed: ${results.summary.failed}\n`;
        testResultContainer.appendChild(summaryElement);
      }
      class Reporter {

        suite(name){
          const element = document.createElement('h2');
          element.textContent = name;
          return element;
        }

        pass(message){
          const element = document.createElement('p');
          element.classList.add('test', 'test-pass');
          element.textContent = message;
          return element;
        }

        fail(message){
          const element = document.createElement('p');
          element.classList.add('test', 'test-fail');
          element.textContent = message;
          return element;
        }

        error(message){
          const element = document.createElement('p');
          element.classList.add('test', 'test-error');
          element.textContent = message;
          return element;
        }

        summary(message){
          const element = document.createElement('p');
          element.classList.add('test', 'test-summary');
          element.textContent = message;
          return element;
        }

        separator(){
          return document.createElement('hr');
        }
      }
      const reporter = new Reporter();
      for( const result of results.output ){
        const resultElement = reporter[result.type](result.message, result.timestamp) ;
        detailsElement.appendChild(resultElement);
      }

    </script>

    <template id="loginTemplate">
      <style>
        /* lightweight, no external libs */
        .login {
          max-width: min(400px, 100vw);
          margin: 2rem auto;
          display: grid;
          gap: 0.5rem;
          font-family: system-ui, sans-serif;

          background: #2c2b32;

          padding: 2rem;
          box-shadow: rgb(0, 0, 0, 0.2) 2px 2px 8px 6px;
          border-radius: 8px;

          &.disabled {
            box-shadow: none;
            transform: translate(2px, 2px);
          }
          .horizontal {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px; /* Adjust the gap between buttons as needed */
          }
        }

        .login label,
        .login > small {
          font-size: 0.9rem;
          color: #555;
          sup {
            float: right;
          }
        }

        .login input {
          padding: 0.4rem 0.5rem;
          border: 1px solid #555;
          border-radius: 4px;
          font-size: 1rem;
        }

        .login button[type="button"] {
          margin-top: 1.5rem;
          padding: 0.5rem;
          border: 1px solid #555;

          border-radius: 4px;
          cursor: pointer;
        }

        .login button[type="submit"] {
          margin-top: 1.5rem;
          padding: 0.5rem;
          background: #0066ff;
          color: #fff;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        .login button:hover {
          background: #0055dd;
        }
        *[disabled] {
          opacity: 0.15;
        }
      </style>
      <form id="loginForm" class="login example">
        <label for="usernameInput">username <sup id="usernameRevisions"></sup></label>
        <input type="text" id="usernameInput" autocomplete="username" />

        <label for="passwordInput">password <sup id="passwordRevisions"></sup></label>
        <input type="text" id="passwordInput" autocomplete="current-password" />
        💾
        <div class="horizontal">
          <button id="dumpButton" type="button">💻 (F12)</button>
          <button id="loadButton" type="button">💾 Load</button>
          <button id="loginButton" type="submit">🧹 Log in &raquo;</button>
        </div>

        <small>user interface simulation</small>
      </form>
    </template>

    <template id="gradientTemplate">
      <style>
        .gradient {
          font-family: system-ui, sans-serif;
          background: #2c2b32;

          margin: 2rem auto;

          padding: 2rem;
          box-shadow: rgb(0, 0, 0, 0.2) 2px 2px 8px 6px;
          border-radius: 8px;
        }
      </style>
      <div id="gradientDemo" class="gradient example">
        <!--<use-template template="gradient-builder" data-context="/my-app/user/gradient.arr"></use-template>-->

        <!--<label for="exampleColorInput" class="form-label">Color picker</label>
        <input type="color" class="form-control form-control-color" id="gradient0colorElement" value="#563d7c" title="Choose your color" />

        <hr />

        <label for="range1" class="form-label">Color stop position</label>
        <input type="range" class="form-range" id="gradient0percentRangeElement" />-->
      </div>
    </template>

    <template id="gradientPreviewTemplate">
      <style>
        .preview-container {
          background: var(--color, rgb(0 0 0 / 0.23));
          border-radius: 4px;
          padding: 0.375rem;
          width: 100%;
          height: 5rem;
          margin-bottom: 2rem;
        }
      </style>
      <div id="preview" style="--color: magenta" class="preview-container"></div>
    </template>

    <template id="colorStopTemplate">
      <style>
        .container {
          background: rgb(0 0 0 / 0.23);
          border-radius: 4px;
          padding: 0.375rem;
        }
        .form-label {
          margin-bottom: 0.5rem;
        }

        .form-control {
          display: block;
          width: 100%;
        }

        label {
          display: inline-block;
        }
      </style>

      <div class="container" style="display: flex; gap: 8px; margin-bottom: 2rem">
        <div style="flex: 15%">
          <!--<label for="color" class="form-label">Color picker</label>-->
          <input type="color" class="form-control" id="color" value="#563d7c" title="Choose your color" />
        </div>
        <div style="flex: 85%">
          <!--<label for="percent" class="form-label">Color stop position</label>-->
          <input type="range" class="form-control" id="percent" />
        </div>
      </div>
    </template>
  </body>
</html>
