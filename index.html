<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>" />
    <title>cede: State Kernel Demo</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
      }
      html {
        color-scheme: light dark;
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
        -moz-tab-size: 4;
        tab-size: 4;
      }
      body {
        padding: 3vh 5vw;
        margin: 0;
        line-height: 1.2;
        -webkit-font-smoothing: antialiased;
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto,
                     Helvetica, Arial, sans-serif, 'Apple Color Emoji',
                     'Segoe UI Emoji', 'Segoe UI Symbol';
      }

    </style>
  </head>
  <body>

    <style>
      /* lightweight, no external libs */
      .login {
        max-width: min(300px, 100vw);
        margin: 2rem auto;
        display: grid;
        gap: 0.5rem;
        font-family: system-ui, sans-serif;

        background: #2c2b32;

        padding: 2rem;
        box-shadow: rgb(0,0,0,0.2) 2px 2px 8px 6px;
        border-radius: 8px;
      }

      .login label, .login > small {
        font-size: 0.9rem;
        color: #555;
      }

      .login input {
        padding: 0.4rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
      }

      .login button {
        margin-top: 1.5rem;
        padding: 0.5rem;
        background: #0066ff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .login button:hover {
        background: #0055dd;
      }
      *[disabled]{
        opacity: .15;
      }
    </style>

    <form class="login">

      <label for="usernameInput">username</label>
      <input type="text" id="usernameInput" autocomplete="username" />

      <label for="passwordInput">password</label>
      <input type="text" id="passwordInput" autocomplete="current-password" />

      <button id="loginButton" type="submit">Log in</button>
      <small>user interface simulation</small>
    </form>

    <h5>Substrate Test Results</h5>
    <pre id="output"></pre>

    <script type="module">
      ////////////////

      import { DisposableSignalListener, DisposableSingleDirectionBinder, DisposableBidirectionalBinder } from "./Disposables.js";

      import { test, describe, it, waitForCompletion } from "./modules/cletus/cletus.js";

      import { Signal } from "./Signal.js";
      import { Tree } from "./Tree.js";

      class DisposableManager {
        #disposables = new Set();

        dispose() {
          this.#disposables.forEach((disposable) => disposable());
          this.#disposables.clear();
        }

        addDisposable(...disposables) {
          disposables.flat(Infinity).forEach(d => this.#disposables.add(d));
        }

      }
      const disposableManager = new DisposableManager();


      localStorage.clear();
      const tree = new Tree("kernel-test", false);

      describe("Tree operations", () => {
        // tree.load({
        //   "my-app": {
        //     "user": {
        //       "profile.obj": {
        //         "id": "d8460a47-fd71-499a-9c75-a379d8349378"
        //       }
        //     },
        //     "workspace": {
        //       "gradient.arr": {
        //         "id": "fa0e44ff-454c-4317-bd09-884cfebdf989"
        //       }
        //     }
        //   }
        // });
        // tree.dump();

        it("should create profile.obj", () => {
          const expected = { password: "hunter2" };
          tree.create("/my-app/user/profile.obj", { username: "zerocool", password: "hunter2" });

          const profile = tree.read("/my-app/user/profile.obj");
          console.assert(profile.ext == "obj", "Does not have .obj extension");
          console.assert(profile.signal instanceof Signal, "Profile's (which is .ext object) .signal must be a signal!");
          console.assert(profile.signal.value instanceof Signal, "The value of the .signal must also be a signal");

          const username = tree.read("/my-app/user/profile.obj/username");
          console.assert(username instanceof Signal, "profile.obj/username must be a signal");
          console.assert(typeof username.value === 'string', "profile.obj/username.value must be a simple primitive string.");

          console.assert(username !== undefined, "Unable to retrieve data from tree, possibly due to new root logic where signal is an actual signal object...");
          console.log(username);

          const disposableUsername = new DisposableBidirectionalBinder(username, usernameInput);

          const password = tree.read('/my-app/user/profile.obj/password');
          const disposablePassword = new DisposableBidirectionalBinder(password, passwordInput);
          console.assert(password.value == "hunter2", `Incorrect password value, received:`, password.value );

          ///

          disposableManager.addDisposable( ()=>disposableUsername.dispose(), ()=>usernameInput.value = '', ()=>usernameInput.setAttribute('disabled', 'disabled') );
          disposableManager.addDisposable( ()=>disposablePassword.dispose(), ()=>passwordInput.value = '', ()=>passwordInput.setAttribute('disabled', 'disabled') );
          disposableManager.addDisposable( ()=>loginButton.setAttribute('disabled', 'disabled') );

        });




        // it("should create profile.obj/password", () => {
        //   const expected = "hunter2";
        //   const password = tree.mk("/my-app/user/profile.obj/password", expected);
        //   const actual = password.value;
        //   console.assert(actual == expected);
        // });

        // it("should create gradient.arr/0/color", () => {
        //   const expected = "#ff0000";
        //   const gradient = tree.mk("/my-app/workspace/gradient.arr/0/color", expected);
        //   const actual = gradient.value;
        //   console.assert(actual == expected);
        // });

        // it("should create gradient.arr/0/percent", () => {
        //   const expected = 0;
        //   const percent = tree.mk("/my-app/workspace/gradient.arr/0/percent", expected);
        //   const actual = percent.value;
        //   console.assert(actual == expected);
        // });

        // it("should return a serializable JSON", { todo: false }, () => {
        //   // console.log( tree.save() );
        //   // const result = tree.load();
        //   // console.log("FLATTENED");
        //   // const flat = tree.flatten();
        //   // console.table(flat);
        //   // console.log(JSON.stringify(flat, 0, 2));
        //   // flat.forEach(o=>tree.mk(o))
        // });

        it("save, clear, and load", {todo:true}, () => {

          const data = JSON.stringify(tree, null, 2);
          tree.save();

          setTimeout(()=>{
            tree.clear();
            disposableManager.dispose();
          }, 30_000);

          // tree.load(data);

        });

      });

      // Wait for tests to complete and display results
      const results = await waitForCompletion();
      document.getElementById("output").textContent = `Passed: ${results.summary.passed}\n` + `Failed: ${results.summary.failed}\n`;
      console.log(results);
      tree.dump();
    </script>
  </body>
</html>
